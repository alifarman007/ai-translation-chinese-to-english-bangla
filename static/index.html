<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Translation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        /* Language Selection */
        .language-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .language-selector h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }

        .language-row {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .language-box {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .language-box label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .language-box select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-box select:focus {
            outline: none;
            border-color: #667eea;
        }

        .swap-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-btn:hover {
            background: #764ba2;
            transform: rotate(180deg);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 30px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            color: #764ba2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Input Sections */
        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .recording-indicator {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background: #ff4444;
            color: white;
            border-radius: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .recording-indicator.active {
            display: block;
        }

        /* Messages */
        .error {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .error.active {
            display: block;
        }

        .success {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c3e6cb;
        }

        .success.active {
            display: block;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results */
        .results {
            display: none;
            margin-top: 30px;
        }

        .results.active {
            display: block;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .result-card.source {
            border-left-color: #dc3545;
        }

        .result-card.target {
            border-left-color: #28a745;
        }

        .result-card h4 {
            color: #333;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .result-card p {
            color: #555;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .confidence {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 8px;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .processing-time {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .content {
                padding: 20px;
            }

            .language-row {
                flex-direction: column;
            }

            .swap-btn {
                transform: rotate(90deg);
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Multilingual Translation System</h1>
            <p>Bidirectional translation: Chinese ‚áÑ English ‚áÑ Bangla</p>
        </div>

        <div class="content">
            <!-- Language Selection -->
            <div class="language-selector">
                <h3>Select Languages</h3>
                <div class="language-row">
                    <div class="language-box">
                        <label>Source Language</label>
                        <select id="sourceLanguage" onchange="updateUI()">
                            <option value="zh-CN">üá®üá≥ Chinese (Mandarin)</option>
                            <option value="en">üá¨üáß English</option>
                            <option value="bn">üáßüá© Bangla</option>
                            <option value="id">üáÆüá© Indonesian</option>
                        </select>
                    </div>

                    <button class="swap-btn" onclick="swapLanguages()" title="Swap languages">‚áÑ</button>

                    <div class="language-box">
                        <label>Target Language</label>
                        <select id="targetLanguage" onchange="updateUI()">
                            <option value="en">üá¨üáß English</option>
                            <option value="bn">üáßüá© Bangla</option>
                            <option value="zh">üá®üá≥ Chinese (Mandarin)</option>
                            <option value="id">üáÆüá© Indonesian</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('text')">Text Translation</button>
                <button class="tab" onclick="switchTab('voice')">Voice Translation</button>
            </div>

            <!-- Error Message -->
            <div class="error" id="errorMsg"></div>

            <!-- Success Message -->
            <div class="success" id="successMsg"></div>

            <!-- Text Translation Tab -->
            <div class="tab-content active" id="textTab">
                <div class="input-section">
                    <h3>Enter Text</h3>
                    <textarea id="textInput" placeholder="Enter text to translate..."></textarea>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="translateText()">
                            Translate Text
                        </button>
                    </div>
                </div>
            </div>

            <!-- Voice Translation Tab -->
            <div class="tab-content" id="voiceTab">
                <div class="input-section">
                    <h3>Upload Audio or Record</h3>
                    <div class="upload-area">
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                Choose Audio File
                            </button>
                            <button class="btn btn-secondary" id="recordBtn" onclick="toggleRecording()">
                                Start Recording
                            </button>
                            <button class="btn btn-primary" id="translateBtn" onclick="translateAudio()" disabled>
                                Translate Audio
                            </button>
                        </div>

                        <input type="file" id="fileInput" accept="audio/*,.mp3,.wav,.flac" onchange="handleFileSelect(event)">

                        <div class="file-info" id="fileInfo"></div>
                        <div class="recording-indicator" id="recordingIndicator">
                            üî¥ Recording... Click "Stop Recording" when done
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">Processing... This may take a few seconds.</p>
            </div>

            <!-- Results -->
            <div class="results" id="results">
                <div id="resultsContainer"></div>
                <div class="processing-time" id="processingTime"></div>
            </div>
        </div>
    </div>

    <!-- Hidden audio players -->
    <div id="audioPlayers"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let selectedFile = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioUrls = {};

        const languageNames = {
            'zh-CN': 'Chinese',
            'zh': 'Chinese',
            'en': 'English',
            'bn': 'Bangla'
        };

        const languageFlags = {
            'zh-CN': 'üá®üá≥',
            'zh': 'üá®üá≥',
            'en': 'üá¨üáß',
            'bn': 'üáßüá©'
        };

        // Update UI based on language selection
        function updateUI() {
            const sourceLang = document.getElementById('sourceLanguage').value;
            const targetLang = document.getElementById('targetLanguage').value;

            // Prevent same source and target
            if (sourceLang === targetLang || (sourceLang === 'zh-CN' && targetLang === 'zh')) {
                // Auto-switch target to a different language
                const targetSelect = document.getElementById('targetLanguage');
                for (let option of targetSelect.options) {
                    if (option.value !== sourceLang && option.value !== 'zh') {
                        targetSelect.value = option.value;
                        break;
                    }
                }
            }
        }

        // Swap source and target languages
        function swapLanguages() {
            const sourceSelect = document.getElementById('sourceLanguage');
            const targetSelect = document.getElementById('targetLanguage');

            const sourceLang = sourceSelect.value;
            const targetLang = targetSelect.value;

            // Map zh to zh-CN for source
            const mappedTarget = targetLang === 'zh' ? 'zh-CN' : targetLang;
            const mappedSource = sourceLang === 'zh-CN' ? 'zh' : sourceLang;

            sourceSelect.value = mappedTarget;
            targetSelect.value = mappedSource;

            updateUI();
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            hideMessages();
            document.getElementById('results').classList.remove('active');
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileInfo').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                document.getElementById('translateBtn').disabled = false;
                hideMessages();
            }
        }

        // Check if browser supports recording
        function checkMicrophoneSupport() {
            if (!navigator.mediaDevices) {
                return {
                    supported: false,
                    error: 'Your browser does not support audio recording. Please use Chrome, Firefox, or Edge, and ensure you are accessing the page via HTTPS or localhost.'
                };
            }

            if (!navigator.mediaDevices.getUserMedia) {
                return {
                    supported: false,
                    error: 'getUserMedia is not supported in your browser. Please update your browser to the latest version.'
                };
            }

            return { supported: true };
        }

        // Toggle recording
        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const indicator = document.getElementById('recordingIndicator');

            if (!isRecording) {
                // Check browser support
                const supportCheck = checkMicrophoneSupport();
                if (!supportCheck.supported) {
                    showError(supportCheck.error);
                    return;
                }

                try {
                    console.log('Requesting microphone access...');

                    // Request microphone access
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });

                    console.log('Microphone access granted');

                    // Check if MediaRecorder is supported
                    if (!window.MediaRecorder) {
                        stream.getTracks().forEach(track => track.stop());
                        showError('MediaRecorder is not supported in your browser. Please use a modern browser.');
                        return;
                    }

                    // Create MediaRecorder
                    let options = { mimeType: 'audio/webm' };

                    // Try different MIME types for compatibility
                    if (!MediaRecorder.isTypeSupported('audio/webm')) {
                        if (MediaRecorder.isTypeSupported('audio/mp4')) {
                            options = { mimeType: 'audio/mp4' };
                        } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                            options = { mimeType: 'audio/ogg' };
                        } else {
                            options = {};
                        }
                    }

                    mediaRecorder = new MediaRecorder(stream, options);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            console.log('Audio chunk recorded:', event.data.size, 'bytes');
                        }
                    };

                    mediaRecorder.onstop = () => {
                        console.log('Recording stopped, total chunks:', audioChunks.length);

                        if (audioChunks.length === 0) {
                            showError('No audio was recorded. Please try again.');
                            return;
                        }

                        // Create blob from recorded chunks
                        const mimeType = mediaRecorder.mimeType || 'audio/webm';
                        const audioBlob = new Blob(audioChunks, { type: mimeType });

                        console.log('Audio blob created:', audioBlob.size, 'bytes');

                        // Determine file extension
                        let extension = 'webm';
                        if (mimeType.includes('mp4')) extension = 'mp4';
                        else if (mimeType.includes('ogg')) extension = 'ogg';
                        else if (mimeType.includes('wav')) extension = 'wav';

                        selectedFile = new File([audioBlob], `recording.${extension}`, { type: mimeType });
                        document.getElementById('fileInfo').textContent = `Recorded: ${(selectedFile.size / 1024).toFixed(2)} KB`;
                        document.getElementById('translateBtn').disabled = false;

                        showSuccess('Recording saved! You can now translate.');
                    };

                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        showError('Recording error: ' + event.error);
                    };

                    // Start recording
                    mediaRecorder.start();
                    console.log('Recording started');

                    isRecording = true;
                    recordBtn.textContent = '‚èπ Stop Recording';
                    recordBtn.classList.remove('btn-secondary');
                    recordBtn.classList.add('btn-primary');
                    indicator.classList.add('active');

                    hideMessages();

                } catch (error) {
                    console.error('Microphone access error:', error);

                    let errorMessage = 'Could not access microphone: ';

                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage += 'Permission denied. Please allow microphone access in your browser settings.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage += 'No microphone found. Please connect a microphone and try again.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage += 'Microphone is already in use by another application.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage += 'Could not satisfy audio constraints.';
                    } else if (error.name === 'TypeError') {
                        errorMessage += 'Please use HTTPS or localhost to enable recording.';
                    } else {
                        errorMessage += error.message || 'Unknown error occurred.';
                    }

                    showError(errorMessage);
                }
            } else {
                // Stop recording
                try {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        console.log('Stopping recording...');
                    }

                    if (mediaRecorder && mediaRecorder.stream) {
                        mediaRecorder.stream.getTracks().forEach(track => {
                            track.stop();
                            console.log('Track stopped:', track.kind);
                        });
                    }
                } catch (error) {
                    console.error('Error stopping recording:', error);
                }

                isRecording = false;
                recordBtn.textContent = 'Start Recording';
                recordBtn.classList.remove('btn-primary');
                recordBtn.classList.add('btn-secondary');
                indicator.classList.remove('active');
            }
        }

        // Translate text
        async function translateText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showError('Please enter text to translate');
                return;
            }

            const sourceLang = document.getElementById('sourceLanguage').value;
            const targetLang = document.getElementById('targetLanguage').value;

            hideMessages();
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingText').textContent = 'Translating and generating audio...';
            document.getElementById('results').classList.remove('active');

            try {
                console.log('Translating text:', text);
                console.log('Source language:', sourceLang);
                console.log('Target language:', targetLang);

                const response = await fetch(`${API_BASE_URL}/translate-text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        source_language: sourceLang,
                        target_languages: [targetLang],
                        generate_audio: true
                    })
                });

                console.log('Response status:', response.status, response.statusText);

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    displayTextResults(data, sourceLang, targetLang);
                    showSuccess('Translation completed successfully!');
                } else {
                    // Show detailed error information
                    let errorMsg = 'Translation failed: ';

                    if (data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg += data.detail;
                        } else if (data.detail.message) {
                            errorMsg += data.detail.message;
                        } else {
                            errorMsg += JSON.stringify(data.detail);
                        }
                    } else if (data.error) {
                        errorMsg += data.error;
                    } else {
                        errorMsg += 'Unknown error (Status: ' + response.status + ')';
                    }

                    console.error('Translation error:', errorMsg);
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Network/Parse error:', error);
                showError('Network error: ' + error.message + '. Make sure the server is running on ' + API_BASE_URL);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Translate audio
        async function translateAudio() {
            if (!selectedFile) {
                showError('Please select or record an audio file first');
                return;
            }

            const sourceLang = document.getElementById('sourceLanguage').value;
            const targetLang = document.getElementById('targetLanguage').value;

            hideMessages();
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingText').textContent = 'Processing audio... This may take a few seconds.';
            document.getElementById('results').classList.remove('active');
            document.getElementById('translateBtn').disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('source_language', sourceLang);
            formData.append('target_languages', targetLang);

            try {
                console.log('Uploading audio file:', selectedFile.name, selectedFile.size, 'bytes');
                console.log('Source language:', sourceLang);
                console.log('Target language:', targetLang);

                const response = await fetch(`${API_BASE_URL}/translate-voice`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status, response.statusText);

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    displayVoiceResults(data, sourceLang, targetLang);
                    showSuccess('Translation completed successfully!');
                } else {
                    // Show detailed error information
                    let errorMsg = 'Translation failed: ';

                    if (data.detail) {
                        // FastAPI error format
                        if (typeof data.detail === 'string') {
                            errorMsg += data.detail;
                        } else if (data.detail.message) {
                            errorMsg += data.detail.message;
                            if (data.detail.errors) {
                                errorMsg += '\nErrors: ' + JSON.stringify(data.detail.errors);
                            }
                        } else {
                            errorMsg += JSON.stringify(data.detail);
                        }
                    } else if (data.error) {
                        errorMsg += data.error;
                    } else if (data.errors && data.errors.length > 0) {
                        errorMsg += data.errors.join(', ');
                    } else {
                        errorMsg += 'Unknown error occurred (Status: ' + response.status + ')';
                    }

                    console.error('Translation error:', errorMsg);
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Network/Parse error:', error);
                showError('Network error: ' + error.message + '. Make sure the server is running on ' + API_BASE_URL);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('translateBtn').disabled = false;
            }
        }

        // Display text translation results
        function displayTextResults(data, sourceLang, targetLang) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            audioUrls = {};

            const sourceName = languageNames[sourceLang];
            const sourceFlag = languageFlags[sourceLang];

            // Source text card
            const sourceCard = document.createElement('div');
            sourceCard.className = 'result-card source';
            sourceCard.innerHTML = `
                <h4>${sourceFlag} Original (${sourceName})</h4>
                <p>${data.original_text}</p>
            `;
            container.appendChild(sourceCard);

            // Translation results
            for (let [langKey, translation] of Object.entries(data.translations)) {
                const targetName = languageNames[targetLang];
                const targetFlag = languageFlags[targetLang];

                const card = document.createElement('div');
                card.className = 'result-card target';

                let audioControls = '';
                if (data.audio_files && data.audio_files[langKey]) {
                    audioUrls[langKey] = data.audio_files[langKey].url;
                    audioControls = `
                        <div class="audio-controls">
                            <button class="btn btn-success" onclick="playAudio('${langKey}')">
                                ‚ñ∂ Play
                            </button>
                            <button class="btn btn-success" onclick="downloadAudio('${langKey}')">
                                ‚¨á Download
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <h4>${targetFlag} ${targetName} Translation</h4>
                    <p>${translation}</p>
                    ${audioControls}
                `;
                container.appendChild(card);
            }

            document.getElementById('results').classList.add('active');
        }

        // Display voice translation results
        function displayVoiceResults(data, sourceLang, targetLang) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            audioUrls = {};

            const sourceName = languageNames[sourceLang];
            const sourceFlag = languageFlags[sourceLang];

            // Transcription card
            const sourceCard = document.createElement('div');
            sourceCard.className = 'result-card source';
            sourceCard.innerHTML = `
                <h4>${sourceFlag} Original (${sourceName})</h4>
                <p>${data.transcription.text}</p>
                <span class="confidence">Confidence: ${(data.transcription.confidence * 100).toFixed(1)}%</span>
            `;
            container.appendChild(sourceCard);

            // Translation results
            for (let [langKey, translation] of Object.entries(data.translations)) {
                const targetName = languageNames[targetLang];
                const targetFlag = languageFlags[targetLang];

                const card = document.createElement('div');
                card.className = 'result-card target';

                let audioControls = '';
                if (data.audio_files && data.audio_files[langKey]) {
                    audioUrls[langKey] = data.audio_files[langKey].url;
                    audioControls = `
                        <div class="audio-controls">
                            <button class="btn btn-success" onclick="playAudio('${langKey}')">
                                ‚ñ∂ Play
                            </button>
                            <button class="btn btn-success" onclick="downloadAudio('${langKey}')">
                                ‚¨á Download
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <h4>${targetFlag} ${targetName} Translation</h4>
                    <p>${translation}</p>
                    ${audioControls}
                `;
                container.appendChild(card);
            }

            // Processing time
            if (data.processing_time) {
                document.getElementById('processingTime').textContent =
                    `Processing completed in ${data.processing_time.toFixed(2)} seconds`;
            }

            document.getElementById('results').classList.add('active');
        }

        // Play audio
        function playAudio(language) {
            const audioUrl = `${API_BASE_URL}${audioUrls[language]}`;

            // Create or get audio element
            let audioPlayer = document.getElementById(`audio_${language}`);
            if (!audioPlayer) {
                audioPlayer = document.createElement('audio');
                audioPlayer.id = `audio_${language}`;
                document.getElementById('audioPlayers').appendChild(audioPlayer);
            }

            audioPlayer.src = audioUrl;
            audioPlayer.load();

            audioPlayer.play()
                .then(() => console.log('Audio playing'))
                .catch(error => {
                    console.error('Error playing audio:', error);
                    showError('Could not play audio. Try downloading instead.');
                });
        }

        // Download audio
        function downloadAudio(language) {
            const url = `${API_BASE_URL}${audioUrls[language]}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Download failed');
                    return response.blob();
                })
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `translation_${language}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                })
                .catch(error => {
                    console.error('Download error:', error);
                    showError('Could not download audio: ' + error.message);
                });
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.add('active');
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = '‚úÖ ' + message;
            successDiv.classList.add('active');
        }

        // Hide messages
        function hideMessages() {
            document.getElementById('errorMsg').classList.remove('active');
            document.getElementById('successMsg').classList.remove('active');
        }

        // Initialize
        updateUI();
    </script>
</body>
</html>
